<script>
const CHECK_INTERVAL_MS = 30000; // 30s
const TARGET_AREA = "Tampines";

let monitorInterval = null;
let isAlertActive = false;
let catCircle = null;

// Use the same map initialized previously (map, marker, circle)
function updateMapCATStatus(color) {
  if(catCircle) catCircle.setMap(null); // remove previous
  catCircle = new google.maps.Circle({
    map: map,
    center: marker.getPosition(),
    radius: 6000,
    fillColor: color,
    fillOpacity: 0.2,
    strokeColor: color,
    strokeOpacity: 0.7,
    strokeWeight: 2
  });
}

// Fetch forecast and update UI/map
async function checkForecast() {
  try {
    const res = await fetch("https://api.data.gov.sg/v1/environment/2-hour-weather-forecast");
    const data = await res.json();
    const forecastItem = data.items[0];
    const areaForecast = forecastItem.forecasts.find(f => f.area.toUpperCase() === TARGET_AREA.toUpperCase());
    const forecastText = areaForecast ? areaForecast.forecast : "Data unavailable";

    const alertKeywords = ["Thunder", "TShowers"];
    const isAlert = alertKeywords.some(k => forecastText.toLowerCase().includes(k.toLowerCase()));

    if(isAlert){
      if(!isAlertActive){ 
        triggerAlert(`Forecast: ${forecastText}`);
      } 
      updateStatus("LIGHTNING ALERT", PASTEL_RED_HEX, true, "ðŸš¨â›ˆï¸");
      updateMapCATStatus("#F08080"); // Red circle
    } else {
      if(isAlertActive){
        clearAlert();
      } else {
        updateStatus(`Safe: ${forecastText}`, PASTEL_GREEN_HEX, true, "âœ…â˜€ï¸");
        updateMapCATStatus("#90EE90"); // Green circle
      }
    }
  } catch(err){
    console.error(err);
    updateStatus("Error fetching forecast", "bg-amber-500", false, "âš ï¸");
    updateMapCATStatus("#FBBE24"); // Yellow for warning/error
  }
}

// Monitor control
function startMonitor(){
  checkForecast(); // immediate check
  if(monitorInterval) clearInterval(monitorInterval);
  monitorInterval = setInterval(checkForecast, CHECK_INTERVAL_MS);
  startBtn.disabled = true;
  stopBtn.disabled = false;
  simulateBtn.disabled = true;
  simulateClearBtn.disabled = true;
}

function stopMonitor(){
  clearInterval(monitorInterval);
  monitorInterval = null;
  isAlertActive = false;
  updateStatus("Stopped", "bg-gray-500", false, "ðŸ›‘");
  updateMapCATStatus("#6B7280"); // gray
  startBtn.disabled = false;
  stopBtn.disabled = true;
  simulateBtn.disabled = false;
  simulateClearBtn.disabled = false;
}

// Simulate buttons
simulateBtn.addEventListener("click", ()=>{
  if(!isAlertActive){
    triggerAlert("Simulated Lightning Alert");
    updateMapCATStatus("#F08080");
  }
});

simulateClearBtn.addEventListener("click", ()=>{
  if(isAlertActive) clearAlert();
  updateMapCATStatus("#90EE90"); // safe
});
</script>
